<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>GunRog— Táo Bắc Việt Team</title>
<link rel="icon" href="LOGO.png" type="image/png">
<style>
  :root{
    --bg:#040512; --panel:#0b1120; --player:#7fe3ff; --enemy:#ff7b7b; --bullet:#fff3a6; --text:#dbe9ff;
    --item-size:22px;
  }
  html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{background:linear-gradient(180deg,#02030a 0%, #060817 100%);display:flex;align-items:center;justify-content:center;padding:16px;color:var(--text)}
  .wrap{width:100%;max-width:520px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  h1{font-size:18px;margin:0;display:flex;align-items:center;gap:6px}
  h1 img{width:24px;height:24px;vertical-align:middle;border-radius:4px}
  .meta{font-size:13px;opacity:.9}
  .game{background:linear-gradient(180deg,#051025 0%, #031022 100%);border-radius:12px;padding:10px;box-shadow:0 8px 30px rgba(0,0,0,.6)}
  canvas{display:block;width:100%;height:auto;border-radius:8px;background:transparent}
  .hud{display:flex;justify-content:space-between;align-items:center;padding:8px 4px;color:var(--text)}
  .btn{background:transparent;border:1px solid rgba(255,255,255,.06);padding:6px 10px;border-radius:8px;font-size:13px;color:var(--text)}
  .controls{display:flex;gap:8px;margin-top:8px}
  .touch-area{position:relative;margin-top:8px;height:64px;border-radius:10px;overflow:hidden}
  .touch-left,.touch-right{position:absolute;top:0;bottom:0;width:50%;}
  .touch-left{left:0}
  .touch-right{right:0}
  .footer{font-size:12px;opacity:.8;margin-top:10px;text-align:center}
  .status{font-size:12px;opacity:.95;margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .tag{background:rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;font-size:12px}
  .temp-timer{font-weight:700;color:#ffd66b}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1><img src="logo.png" alt="logo"> GunRog</h1>
    <div class="meta">Táo Bắc Việt Team</div>
  </header>

  <div class="game">
    <div class="hud">
      <div>Score: <span id="score">0</span></div>
      <div>Life: <span id="life">3</span></div>
      <div><button id="restart" class="btn">Restart</button></div>
    </div>

    <canvas id="c" width="900" height="600" aria-label="GunRog game"></canvas>

    <div class="controls">
      <button id="leftBtn" class="btn" style="flex:1">◀</button>
      <button id="shootBtn" class="btn" style="flex:1">Fire</button>
      <button id="rightBtn" class="btn" style="flex:1">▶</button>
    </div>

    <div class="touch-area" aria-hidden="true">
      <div class="touch-left" id="touchLeft"></div>
      <div class="touch-right" id="touchRight"></div>
    </div>

    <div class="status" id="status">
      <div class="tag">Weapon: <span id="w-name">Normal</span></div>
      <div class="tag">Fire Rate: <span id="w-rate">160ms</span></div>
      <div class="tag">Damage: <span id="w-dmg">1</span></div>
      <div class="tag">Size: <span id="w-size">6</span></div>
      <div class="tag">Multi: <span id="w-multi">1</span></div>
      <div class="tag">Temp Multi: <span id="temp-multi" class="temp-timer">—</span></div>
    </div>
  </div>

  <div class="footer">© 2025 Táo Bắc Việt Team — Bản quyền thuộc về Táo Bắc Việt Team.</div>
</div>

<script>
(() => {
  // ---- Cấu hình & Canvas ----
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d');
  const W = 900, H = 600; canvas.width = W; canvas.height = H;

  // UI
  const scoreEl = document.getElementById('score');
  const lifeEl = document.getElementById('life');
  const restartBtn = document.getElementById('restart');
  const leftBtn = document.getElementById('leftBtn');
  const rightBtn = document.getElementById('rightBtn');
  const shootBtn = document.getElementById('shootBtn');
  const touchLeft = document.getElementById('touchLeft');
  const touchRight = document.getElementById('touchRight');

  const wNameEl = document.getElementById('w-name');
  const wRateEl = document.getElementById('w-rate');
  const wDmgEl = document.getElementById('w-dmg');
  const wSizeEl = document.getElementById('w-size');
  const wMultiEl = document.getElementById('w-multi');
  const tempMultiEl = document.getElementById('temp-multi');

  // Sounds (online fallback; thay bằng file local nếu muốn)
  const shootSound = new Audio('https://cdn.pixabay.com/download/audio/2022/03/15/audio_4822dbb024.mp3?filename=shooting-sound-10695.mp3');
  const explosionSound = new Audio('https://cdn.pixabay.com/download/audio/2022/03/15/audio_1d7a9b6b0e.mp3?filename=small-explosion-6056.mp3');
  const bigExplosionSound = new Audio('https://cdn.pixabay.com/download/audio/2022/04/07/audio_9a6a2b0c9b.mp3?filename=big-explosion-120455.mp3');

  // ---- Trạng thái game ----
  let last = performance.now(), running=true;
  let score = 0, life = 3;
  let player = {x: W/2, y: H - 90, w: 48, h: 48, vx:0, speed:360};

  // Weapon: base (permanent upgrades affect these)
  const weapon = {
    name: 'Normal',
    fireDelay: 160, // ms
    damage: 1,
    size: 6,
    multi: 1, // permanent multi
    lastFire: 0,
    // temporary multi (time-limited power-up)
    tempMultiAmount: 0,   // extra bullets while active
    tempMultiUntil: 0     // performance.now() timestamp when it ends
  };

  // Entities
  let bullets = [];
  let enemies = [];
  let particles = [];
  let items = [];
  let missiles = [];
  let spawnTimer = 0;

  // Limits to prevent "ngập đạn"
  const MAX_BULLETS = 140;    // tổng viên trên màn tối đa
  const MAX_PARTICLES = 800;   // giới hạn particle
  const MAX_MISSILES = 8;

  // Utils
  function rand(a,b){ return Math.random()*(b-a)+a; }
  function now(){ return performance.now(); }
  function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }

  // ---- Spawner & VFX ----
  function spawnEnemy(){
    const type = Math.random() < 0.12 ? 'big' : Math.random()<0.35 ? 'fast' : 'small';
    if(type==='big') enemies.push({x:rand(60,W-60), y:-80, w:80, h:80, vy:70, hp:4, score:50, color:'#ff8b8b'});
    else if(type==='fast') enemies.push({x:rand(40,W-40), y:-60, w:48, h:48, vy:220, hp:1, score:15, color:'#ffd56b'});
    else enemies.push({x:rand(30,W-30), y:-40, w:36, h:36, vy:120, hp:1, score:10, color:'#9bff9b'});
  }

  // Màu sắc & hạt nổ đổi màu
  function createExplosion(x,y,size=1,strength=1){
    particles.push({x,y,life:400*size,age:0,sz:60*size,type:'flash'});
    const count = Math.round(14 * strength);
    for(let i=0;i<count;i++){
      const a = rand(0,Math.PI*2), s = rand(80,300)*size;
      particles.push({
        x,y,
        vx: Math.cos(a)*s,
        vy: Math.sin(a)*s,
        life: rand(500,1100),
        age:0,
        r: rand(2,6)*size,
        hue: Math.random()*360,
        type:'shard'
      });
    }
    explosionSound.currentTime = 0; try{ explosionSound.play(); }catch(e){}
    // trim particles
    if(particles.length > MAX_PARTICLES) particles.splice(0, particles.length - MAX_PARTICLES);
  }

  function nuked(){
    const cnt = enemies.length;
    enemies = [];
    createExplosion(W/2, H/2, 6, 10);
    bigExplosionSound.currentTime = 0; try{ bigExplosionSound.play(); }catch(e){}
    score += cnt * 30;
  }

  // ---- Bullets & Missiles ----
  function spawnBullet(x,y,angle= -Math.PI/2, speed=520, r=6, dmg=1, type='bullet'){
    if(bullets.length >= MAX_BULLETS) return; // giới hạn tổng bullets
    bullets.push({x,y,angle,speed,r,dmg,type});
  }

  function spawnMissile(x,y,angle=-Math.PI/2,speed=260,r=36,homing=false){
    if(missiles.length >= MAX_MISSILES) return;
    missiles.push({x,y,angle,speed,r,homing});
  }

  // ---- Fire logic: dùng temp multi khi active ----
  function fire(){
    if(!running) return;
    const t = now();
    if(t - weapon.lastFire < weapon.fireDelay) return;
    weapon.lastFire = t;

    // compute current multi: base permanent + temporary (if active)
    const tempActive = weapon.tempMultiUntil > now();
    const tempAdd = tempActive ? weapon.tempMultiAmount : 0;
    const multi = clamp(weapon.multi + tempAdd, 1, 6);

    // spread depends on multi
    const base = -Math.PI/2;
    const spread = 0.16 + (multi-1)*0.04; // more bullets -> wider spread slightly
    for(let i=0;i<multi;i++){
      const off = (i - (multi-1)/2) * spread;
      spawnBullet(player.x, player.y-30, base+off, 520, weapon.size, weapon.damage, 'bullet');
    }
    // muzzle flash particles
    for(let p=0;p<6;p++) particles.push({
      x: player.x, y: player.y-22,
      vx: (Math.random()-0.5)*120, vy: -Math.random()*140,
      life: rand(120,260), age:0, r: rand(1,3), hue: Math.random()*360, type:'shard'
    });
    shootSound.currentTime = 0; try{ shootSound.play(); }catch(e){}
  }

  // ---- Collision ----
  function rectIntersect(x1,y1,w1,h1,x2,y2,w2,h2){ return !(x2 > x1+w1 || x2+w2 < x1 || y2 > y1+h1 || y2+h2 < y1); }
  function pointRectIntersect(px,py, rx,ry,rw,rh){ return px >= rx && px <= rx+rw && py >= ry && py <= ry+rh; }

  // ---- Items (1 khối item mỗi địch) ----
  // Types: 'multiShot' (temporary), 'bigMissile', 'nuke', 'homing', 'heal', 'upgrade' (vĩnh viễn)
  function spawnItem(x,y){
    const roll = Math.random();
    let type;
    if(roll < 0.10) type = 'nuke';
    else if(roll < 0.22) type = 'bigMissile';
    else if(roll < 0.38) type = 'homing';
    else if(roll < 0.62) type = 'multiShot';
    else if(roll < 0.82) type = 'heal';
    else type = 'upgrade';
    const map = {
      nuke: '#ff4d4d',
      bigMissile: '#ff8b00',
      homing: '#a86bff',
      multiShot: '#ffd66b',
      heal: '#7df29b',
      upgrade: '#6bd0ff'
    };
    items.push({x, y, r: 14, type, hue: Math.random()*360, vy: 40, color: map[type] || '#fff'});
  }

  // ---- Áp dụng hiệu ứng khi nhặt item ----
  function applyItemEffect(type){
    if(type === 'multiShot'){
      // Tạm thời tăng số đạn: +2 (ví dụ) trong 9 giây
      const ADD = 2;
      const DURATION_MS = 9000;
      // Gộp nếu đang active: thêm vào thời gian hoặc làm mới
      const nowT = now();
      // nếu đang active, tăng lượng thêm lên (nhiều item chồng), và kéo dài thời gian
      weapon.tempMultiAmount = Math.min(4, weapon.tempMultiAmount + ADD); // giới hạn thêm
      weapon.tempMultiUntil = nowT + DURATION_MS;
      // nhỏ burst visual khi nhặt
      for(let a=0;a<12;a++){
        particles.push({
          x: player.x, y: player.y-20, vx:(Math.random()-0.5)*300, vy:(Math.random()-1.2)*300, life:rand(300,700), age:0, r: rand(2,5), hue: Math.random()*360, type:'shard'
        });
      }
      weapon.name = 'Temp Multi';
      updateWeaponUI();
    } else if(type === 'bigMissile'){
      spawnMissile(player.x, player.y-40, -Math.PI/2, 260, 46, false);
      weapon.size = Math.min(56, weapon.size + 2);
      weapon.name = 'Missile+';
      updateWeaponUI();
    } else if(type === 'nuke'){
      nuked();
      weapon.damage = Math.min(20, weapon.damage + 1);
      weapon.name = 'NukeBoost';
      updateWeaponUI();
    } else if(type === 'homing'){
      // 2 homing missiles now; small permanent firerate buff
      for(let i=0;i<2;i++) spawnMissile(player.x + (i?18:-18), player.y-40, -Math.PI/2, 220, 26, true);
      weapon.fireDelay = Math.max(50, weapon.fireDelay - 8);
      weapon.name = 'Homing+';
      updateWeaponUI();
    } else if(type === 'heal'){
      life = Math.min(9, life + 1);
    } else if(type === 'upgrade'){
      // vĩnh viễn: chọn 1 trong 4
      const u = Math.random();
      if(u < 0.25){
        weapon.fireDelay = Math.max(40, weapon.fireDelay - 12);
        weapon.name = 'Firerate+';
      } else if(u < 0.5){
        weapon.damage = Math.min(25, weapon.damage + 1);
        weapon.name = 'Power+';
      } else if(u < 0.75){
        weapon.size = Math.min(64, weapon.size + 3);
        weapon.name = 'Size+';
      } else {
        weapon.multi = Math.min(4, weapon.multi + 1);
        weapon.name = 'Multi+';
      }
      updateWeaponUI();
    }
  }

  // ---- Update loop ----
  function update(dt){
    if(!running) return;
    // player movement
    player.x += player.vx * dt;
    player.x = clamp(player.x, 30, W-30);

    // bullets movement & behavior
    for(let i=bullets.length-1;i>=0;i--){
      const b = bullets[i];
      // if homing bullet type implement if needed - currently missiles homing
      b.x += Math.cos(b.angle) * b.speed * dt;
      b.y += Math.sin(b.angle) * b.speed * dt;
      if(b.x < -40 || b.x > W+40 || b.y < -60 || b.y > H+60){ bullets.splice(i,1); continue; }
    }

    // missiles
    for(let i=missiles.length-1;i>=0;i--){
      const m = missiles[i];
      if(m.homing && enemies.length>0){
        let best = null, bestDist = 1e9;
        for(const e of enemies){
          const d = Math.hypot(e.x - m.x, e.y - m.y);
          if(d < bestDist){ bestDist = d; best = e; }
        }
        if(best){
          const targetAngle = Math.atan2(best.y - m.y, best.x - m.x);
          const diff = ((targetAngle - m.angle + Math.PI) % (2*Math.PI)) - Math.PI;
          m.angle += diff * 0.06;
        }
      }
      m.x += Math.cos(m.angle) * m.speed * dt;
      m.y += Math.sin(m.angle) * m.speed * dt;
      // collision with enemies
      for(let j=enemies.length-1;j>=0;j--){
        const e = enemies[j];
        if(rectIntersect(m.x-m.r, m.y-m.r, m.r*2, m.r*2, e.x-e.w/2, e.y-e.h/2, e.w, e.h)){
          createExplosion(m.x, m.y, m.r/35, 1.6);
          // area damage
          const dmgRad = m.r*2.2;
          for(let k=enemies.length-1;k>=0;k--){
            const ee = enemies[k];
            const d = Math.hypot(ee.x - m.x, ee.y - m.y);
            if(d <= dmgRad){
              score += ee.score;
              enemies.splice(k,1);
            }
          }
          missiles.splice(i,1);
          break;
        }
      }
      if(m.x < -100 || m.x > W+100 || m.y < -100 || m.y > H+100) missiles.splice(i,1);
    }

    // enemies
    for(let i=enemies.length-1;i>=0;i--){
      const e = enemies[i];
      e.y += e.vy * dt;
      if(e.y > H+80){ enemies.splice(i,1); continue; }
      // bullets hit enemy
      let hit = false;
      for(let j=bullets.length-1;j>=0;j--){
        const b = bullets[j];
        if(rectIntersect(b.x-b.r, b.y-b.r, b.r*2, b.r*2, e.x-e.w/2, e.y-e.h/2, e.w, e.h)){
          bullets.splice(j,1);
          e.hp -= b.dmg;
          // small hit particles
          for(let p=0;p<6;p++) particles.push({
            x: b.x, y: b.y, vx: (Math.random()-0.5)*200, vy:(Math.random()-0.5)*200, life:rand(200,500), age:0, r:rand(1,3), hue: Math.random()*360, type:'shard'
          });
          hit = true;
          if(e.hp<=0){
            createExplosion(e.x, e.y, e.w/60, 1.2);
            spawnItem(e.x, e.y); // 1 khối item
            score += e.score;
            enemies.splice(i,1);
          }
          if(hit) break;
        }
      }
      // collide with player
      if(rectIntersect(player.x-player.w/2, player.y-player.h/2, player.w, player.h,
                       e.x-e.w/2, e.y-e.h/2, e.w, e.h)){
        createExplosion(player.x, player.y, 0.8, 1);
        enemies.splice(i,1);
        life--; if(life<=0){ running=false; }
      }
    }

    // items: fall & pickup
    for(let i=items.length-1;i>=0;i--){
      const it = items[i];
      it.y += it.vy * dt;
      it.vy = clamp(it.vy + 600 * dt, -1000, 500);
      if(pointRectIntersect(it.x, it.y, player.x-player.w/2, player.y-player.h/2, player.w, player.h)){
        applyItemEffect(it.type);
        for(let p=0;p<10;p++) particles.push({
          x: it.x, y: it.y, vx: (Math.random()-0.5)*180, vy:(Math.random()-0.5)*180, life:rand(300,700), age:0, r:rand(2,5), hue: it.hue, type:'shard'
        });
        items.splice(i,1);
      } else if(it.y > H+30) items.splice(i,1);
    }

    // particles
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.age += dt*1000;
      if(p.type === 'shard'){
        p.x += (p.vx||0) * dt;
        p.y += (p.vy||0) * dt;
        p.vy = (p.vy||0) + 400 * dt;
        if(p.age >= p.life) particles.splice(i,1);
      } else if(p.type === 'flash'){
        if(p.age >= p.life) particles.splice(i,1);
      }
    }
    if(particles.length > MAX_PARTICLES) particles.splice(0, particles.length - MAX_PARTICLES);

    // spawn enemies
    spawnTimer -= dt;
    if(spawnTimer <= 0){ spawnTimer = rand(0.45,1.05); spawnEnemy(); }

    // score drift
    score += dt * 3;

    // temp multi expiry check: if expired, reset temp values
    if(weapon.tempMultiUntil > 0 && weapon.tempMultiUntil <= now()){
      weapon.tempMultiAmount = 0;
      weapon.tempMultiUntil = 0;
      weapon.name = 'Normal';
      updateWeaponUI();
    }

    // cap bullets again (defensive)
    if(bullets.length > MAX_BULLETS) bullets.splice(0, bullets.length - MAX_BULLETS);
  }

  // ---- Render ----
  function render(){
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle = '#020317'; ctx.fillRect(0,0,W,H);
    for(let i=0;i<80;i++){ ctx.fillStyle = 'rgba(255,255,255,0.03)'; ctx.fillRect((i*37)%W, (i*67)%H, 2,2); }

    // player
    ctx.save(); ctx.translate(player.x, player.y);
    ctx.fillStyle = getComputedStyle(document.documentElement).getPropertyValue('--player');
    triangle(ctx, 0, -22, -18, 20, 18, 20);
    ctx.restore();

    // bullets
    bullets.forEach(b=>{
      ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2);
      ctx.fillStyle = 'rgba(255, 243, 166, 0.95)'; ctx.fill();
    });

    // missiles
    missiles.forEach(m=>{
      ctx.save(); ctx.translate(m.x, m.y); ctx.rotate(m.angle + Math.PI/2);
      ctx.fillStyle = m.homing ? '#b78bff' : '#ffb36b';
      roundRect(ctx, -m.r/2, -m.r, m.r, m.r*1.8, 8, true, false);
      ctx.restore();
    });

    // enemies
    enemies.forEach(e=>{
      ctx.save(); ctx.translate(e.x, e.y);
      ctx.fillStyle = e.color;
      roundRect(ctx, -e.w/2, -e.h/2, e.w, e.h, 10, true, false);
      // HP bar
      ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(-e.w/2, -e.h/2 - 8, e.w, 5);
      const hpFrac = (e.hp > 0 ? e.hp : 0) / (e.hp > 0 ? e.hp : 1);
      ctx.fillStyle = 'rgba(255,255,255,0.9)'; ctx.fillRect(-e.w/2, -e.h/2 - 8, e.w * (e.hp / (e.hp>0? e.hp : 1 + 0.0001)), 5);
      ctx.restore();
    });

    // items
    items.forEach(it=>{
      ctx.beginPath(); ctx.arc(it.x, it.y, it.r, 0, Math.PI*2);
      ctx.fillStyle = it.color; ctx.fill();
      ctx.beginPath(); ctx.arc(it.x, it.y, it.r+4, 0, Math.PI*2);
      ctx.strokeStyle = 'rgba(255,255,255,0.06)'; ctx.stroke();
    });

    // particles
    particles.forEach(p=>{
      if(p.type === 'flash'){
        const t = p.age / p.life;
        const a = Math.max(0, 1 - t);
        const rad = p.sz * (1 + t*1.4);
        ctx.beginPath(); ctx.arc(p.x, p.y, rad, 0, Math.PI*2);
        ctx.fillStyle = `rgba(255,255,255,${0.18*a})`; ctx.fill();
      } else if(p.type === 'shard'){
        const t = p.age / p.life;
        const hue = (p.hue + t*240) % 360;
        ctx.fillStyle = `hsl(${hue},80% ,60%)`;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.r*(1-t*0.6), 0, Math.PI*2); ctx.fill();
      }
    });

    // HUD big score
    ctx.fillStyle = 'rgba(255,255,255,0.06)'; ctx.font='80px system-ui'; ctx.textAlign='right'; ctx.fillText(Math.floor(score), W-36, 80);

    if(!running){
      ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(0,0,W,H);
      ctx.fillStyle='white'; ctx.font='40px system-ui'; ctx.textAlign='center'; ctx.fillText('Game Over', W/2, H/2 - 6);
      ctx.font='20px system-ui'; ctx.fillText('Nhấn Restart để chơi lại', W/2, H/2 + 26);
    }
  }

  // ---- Helpers ----
  function triangle(ctx,x1,y1,x2,y2,x3,y3){ ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.lineTo(x3,y3); ctx.closePath(); ctx.fill(); }
  function roundRect(ctx,x,y,w,h,r,fill,stroke){ if(!r) r=6; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+w-r,y); ctx.quadraticCurveTo(x+w,y,x+w,y+r); ctx.lineTo(x+w,y+h-r); ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h); ctx.lineTo(x+r,y+h); ctx.quadraticCurveTo(x,y+h,x,y+h-r); ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath(); if(fill) ctx.fill(); if(stroke) ctx.stroke(); }

  // ---- Input ----
  leftBtn.addEventListener('pointerdown', ()=>{ player.vx = -player.speed; }); leftBtn.addEventListener('pointerup', ()=>{ player.vx = 0; });
  rightBtn.addEventListener('pointerdown', ()=>{ player.vx = player.speed; }); rightBtn.addEventListener('pointerup', ()=>{ player.vx = 0; });
  shootBtn.addEventListener('click', ()=>fire());

  touchLeft.addEventListener('touchstart', (e)=>{ e.preventDefault(); player.vx = -player.speed; },{passive:false});
  touchLeft.addEventListener('touchend', (e)=>{ e.preventDefault(); player.vx = 0; },{passive:false});
  touchRight.addEventListener('touchstart', (e)=>{ e.preventDefault(); player.vx = player.speed; },{passive:false});
  touchRight.addEventListener('touchend', (e)=>{ e.preventDefault(); player.vx = 0; },{passive:false});

  window.addEventListener('keydown', (e)=>{ if(e.key==='ArrowLeft') player.vx = -player.speed; if(e.key==='ArrowRight') player.vx = player.speed; if(e.key===' ') fire(); });
  window.addEventListener('keyup', (e)=>{ if(e.key==='ArrowLeft' || e.key==='ArrowRight') player.vx = 0; });

  restartBtn.addEventListener('click', ()=>{ reset(); });

  // ---- Fit canvas ----
  function fitCanvas(){ const containerW = Math.min(window.innerWidth-32,520); const scale = containerW / W; canvas.style.width = Math.round(W*scale)+'px'; canvas.style.height = Math.round(H*scale)+'px'; }
  window.addEventListener('resize', fitCanvas); fitCanvas();

  // ---- Reset ----
  function reset(){
    score = 0; life = 3; bullets = []; enemies = []; particles = []; items = []; missiles = []; spawnTimer = 0; player.x = W/2; running = true;
    // reset weapon to base on restart (vì permanent upgrades là khi chơi, bạn có thể chọn giữ nếu muốn)
    weapon.name = 'Normal'; weapon.fireDelay = 160; weapon.damage = 1; weapon.size = 6; weapon.multi = 1; weapon.lastFire = 0;
    weapon.tempMultiAmount = 0; weapon.tempMultiUntil = 0;
    updateWeaponUI();
  }

  // ---- UI cập nhật cho weapon & temp timer ----
  function updateWeaponUI(){
    wNameEl.textContent = weapon.name;
    wRateEl.textContent = weapon.fireDelay + 'ms';
    wDmgEl.textContent = weapon.damage;
    wSizeEl.textContent = weapon.size;
    wMultiEl.textContent = weapon.multi + (weapon.tempMultiAmount>0 ? ('+'+weapon.tempMultiAmount) : '');
    // temp timer
    if(weapon.tempMultiUntil > now()){
      const rem = Math.ceil((weapon.tempMultiUntil - now())/1000);
      tempMultiEl.textContent = rem + 's';
    } else {
      tempMultiEl.textContent = '—';
    }
  }

  // ---- Game loop ----
  function loop(nowTime){
    const dt = Math.min(1/30, (nowTime-last)/1000);
    last = nowTime;
    update(dt);
    render();
    scoreEl.textContent = Math.floor(score);
    lifeEl.textContent = life;
    updateWeaponUI();
    requestAnimationFrame(loop);
  }
  reset(); requestAnimationFrame(loop);

  // double-click spawn item (debug)
  canvas.addEventListener('dblclick', (e)=>{
    const r = canvas.getBoundingClientRect();
    const mx = (e.clientX - r.left) * (W / r.width);
    const my = (e.clientY - r.top) * (H / r.height);
    spawnItem(mx,my);
  });

  // expose for console tweaks
  window.gunrog = { spawnItem, spawnEnemy, nuked, weapon };

})();
</script>
</body>
</html>

